---
title: "DSA5103 Final Project"
author: "Dylan Steimel and Constantine Kutson"
date: "10/27/2022"
output: pdf_document
---

```{r load_libs}
library(dplyr)
#install.packages("hash")
library(hash)
library(tidyverse)
library(lubridate)
```

```{r load_data}
data_2022 = read.csv(file = 'pbp-2022.csv')
data_2021 = read.csv(file = 'pbp-2021.csv')
data_2020 = read.csv(file = 'pbp-2020.csv')
data_2019 = read.csv(file = 'pbp-2019.csv')
data_2018 = read.csv(file = 'pbp-2018.csv')
data_2017 = read.csv(file = 'pbp-2017.csv')
data_2016 = read.csv(file = 'pbp-2016.csv')
data_2015 = read.csv(file = 'pbp-2015.csv')
data_2014 = read.csv(file = 'pbp-2014.csv')
data_2013 = read.csv(file = 'pbp-2013.csv')
```



```{r}
#### Data Preparation ####

## Removing NA Rows From Quarter Column
data_2013 <- data_2013 %>% 
  drop_na(Quarter)

## Removing NA's from Date Column for Easier Data Conversion
data_2013 <- data_2013 %>% 
  drop_na(GameDate)

## Converting relevant columns to appropriate column types
data_2013 <- transform(data_2013, GameId = as.numeric(GameId),
                       Quarter = as.numeric(Quarter),
                       Minute = as.numeric(Minute), 
                       Second= as.numeric(Second),
                       Down = as.numeric(Down), 
                       ToGo = as.numeric(ToGo),
                       YardLine = as.numeric(YardLine), 
                       SeriesFirstDown = as.numeric(SeriesFirstDown),
                       NextScore = as.numeric(NextScore), 
                       TeamWin = as.numeric(TeamWin),
                       SeasonYear = as.numeric(SeasonYear),
                       Yards = as.numeric(Yards), 
                       IsRush = as.numeric(IsRush), 
                       IsPass = as.numeric(IsPass), 
                       IsIncomplete = as.numeric(IsIncomplete), 
                       IsSack = as.numeric(IsSack), 
                       IsChallenge = as.numeric(IsChallenge), 
                       IsTouchdown = as.numeric(IsTouchdown),
                       IsChallengeReversed = as.numeric(IsChallengeReversed),
                       IsMeasurement = as.numeric(IsMeasurement), 
                       IsInterception = as.numeric(IsInterception),
                       IsFumble = as.numeric(IsFumble), 
                       IsPenalty = as.numeric(IsPenalty), 
                       IsTwoPointConversion = as.numeric(IsTwoPointConversion),
                       IsTwoPointConversionSuccessful = as.numeric(IsTwoPointConversionSuccesful),
                       YardLineFixed = as.numeric(YardLineFixed), 
                       IsPenaltyAccepted = as.numeric(IsPenaltyAccepted), 
                       IsNoPlay = as.numeric(IsNoPlay), 
                       PenaltyYards = as.numeric(PenaltyYards))

## Turning Date Column Into column type (Date)
data_2013$GameDate <- ymd(data_2013$GameDate)
```

```{r}
#### Character Data Quality Report #### 

## Selecting variables based on column type
data_2013_character_variables <- data_2013 %>% 
  select_if(is.character)

data_2013_numeric_variables <- data_2013 %>% 
  select_if(is.numeric)

## Calculating empty observations
data_2013_chr_observations <- rbind(
        sum(data_2013$OffenseTeam != ""),
        sum(data_2013$DefenseTeam != ""),
        sum(data_2013$X != ""),
        sum(data_2013$X.1 != ""),
        sum(data_2013$Description != ""),
        sum(data_2013$X.2 != ""),
        sum(data_2013$X.3 != ""),
        sum(data_2013$Formation != ""),
        sum(data_2013$PlayType != ""),
        sum(data_2013$PassType != ""),
        sum(data_2013$Challenger != ""),
        sum(data_2013$RushDirection != ""),
        sum(data_2013$YardLineDirection != ""),
        sum(data_2013$PenaltyTeam != ""),
        sum(data_2013$PenaltyType != ""))

## Creating vector with column names
data_2013_variables <- c(colnames(data_2013_character_variables))

## Binding no observations with column name and cleaning table
N_Chr <- cbind(data_2013_variables, data_2013_chr_observations)
N_Chr <- as.data.frame(N_Chr)
N_Chr <- transform(N_Chr, Chr_Observations = as.numeric(V2))
N_Chr <- N_Chr[,-2]

## Calcuating unique variables across all columns
Unique_Chr_Variables <- rapply(data_2013_character_variables,function(x)length(unique(x)))

## Renaming and calculating missing percentages for final table
Character_Data_Report <- N_Chr %>% 
  rename(N = Chr_Observations) %>% 
  cbind(Unique_Chr_Variables) %>% 
  mutate(Missing = (17448 - N),
         Missing_Pct = (100 * (Missing / 17448)),
         Missing_Pct = round(Missing_Pct, digits = 1),
         Unique_Pct = ((Unique_Chr_Variables / N) * 100),
         Unique_Pct = round(Unique_Pct, digits = 1)) 

## Checking to see what is in these random columns
X <- data_2013$X
X1 <- data_2013$X.1
X2 <- data_2013$X.2
X3 <- data_2013$X.3
X_Columns <- as.data.frame(cbind(X, X1, X2, X3))
X_Columns <- X_Columns[!apply(X_Columns == "", 1, all),]
```

```{r}
#### Numeric Data Quality Report
Numeric_NA <- colSums(is.na(data_2013_numeric_variables))
Numeric_Colnames <- colnames(data_2013_numeric_variables)
Numeric_Rows <- rep(17448, 29)
N_Nur <- cbind(Numeric_Colnames, Numeric_Rows, Numeric_NA)
N_Nur <- as.data.frame(N_Nur)
N_Nur <- transform(N_Nur, Numeric_NA = as.numeric(Numeric_NA),
                   Numeric_Rows = as.numeric(Numeric_Rows))

Unique_Nur_Variables <- rapply(data_2013_numeric_variables,function(x)length(unique(x)))

Numeric_Data_Report <- N_Nur %>% 
  cbind(Unique_Nur_Variables) %>% 
  mutate(Missing_Pct = ((Numeric_NA/Numeric_Rows) * 100),
         Unique_Pct = ((Unique_Nur_Variables / Numeric_Rows) * 100),
         Missing_Pct = round(Missing_Pct, digits = 1),
         Unique_Pct = round(Unique_Pct, digits = 1)) %>% 
  dplyr::select(-Numeric_Colnames) %>% 
  rename(N = Numeric_Rows,
         Missing = Numeric_NA,
         "Unique Values" = Unique_Nur_Variables,
         "Missing Percentage" = Missing_Pct,
         "Unique Percentage" = Unique_Pct)
```

```{r}
Character_Data_Report %>% kable()
Numeric_Data_Report %>% kable()
```


```{r}
#### Character Data Quality Report #### 

## Selecting variables based on column type
data_2013_character_variables <- data_2013 %>% 
  select_if(is.character)

data_2013_numeric_variables <- data_2013 %>% 
  select_if(is.numeric)

## Calculating empty observations
data_2013_chr_observations <- rbind(
        sum(data_2013$OffenseTeam != ""),
        sum(data_2013$DefenseTeam != ""),
        sum(data_2013$X != ""),
        sum(data_2013$X.1 != ""),
        sum(data_2013$Description != ""),
        sum(data_2013$X.2 != ""),
        sum(data_2013$X.3 != ""),
        sum(data_2013$Formation != ""),
        sum(data_2013$PlayType != ""),
        sum(data_2013$PassType != ""),
        sum(data_2013$Challenger != ""),
        sum(data_2013$RushDirection != ""),
        sum(data_2013$YardLineDirection != ""),
        sum(data_2013$PenaltyTeam != ""),
        sum(data_2013$PenaltyType != ""))

## Creating vector with column names
data_2013_variables <- c(colnames(data_2013_character_variables))

## Binding no observations with column name and cleaning table
N_Chr <- cbind(data_2013_variables, data_2013_chr_observations)
N_Chr <- as.data.frame(N_Chr)
N_Chr <- transform(N_Chr, Chr_Observations = as.numeric(V2))
N_Chr <- N_Chr[,-2]

## Calcuating unique variables across all columns
Unique_Chr_Variables <- rapply(data_2013_character_variables,function(x)length(unique(x)))

## Renaming and calculating missing percentages for final table
Character_Data_Report <- N_Chr %>% 
  rename(N = Chr_Observations) %>% 
  cbind(Unique_Chr_Variables) %>% 
  mutate(Missing = (17448 - N),
         Missing_Pct = (100 * (Missing / 17448)),
         Missing_Pct = round(Missing_Pct, digits = 1),
         Unique_Pct = ((Unique_Chr_Variables / N) * 100),
         Unique_Pct = round(Unique_Pct, digits = 1)) 

## Checking to see what is in these random columns
X <- data_2013$X
X1 <- data_2013$X.1
X2 <- data_2013$X.2
X3 <- data_2013$X.3
X_Columns <- as.data.frame(cbind(X, X1, X2, X3))
X_Columns <- X_Columns[!apply(X_Columns == "", 1, all),]
```

```{r}
#### Numeric Data Quality Report
Numeric_NA <- colSums(is.na(data_2013_numeric_variables))
Numeric_Colnames <- colnames(data_2013_numeric_variables)
Numeric_Rows <- rep(17448, 29)
N_Nur <- cbind(Numeric_Colnames, Numeric_Rows, Numeric_NA)
N_Nur <- as.data.frame(N_Nur)
N_Nur <- transform(N_Nur, Numeric_NA = as.numeric(Numeric_NA),
                   Numeric_Rows = as.numeric(Numeric_Rows))

Unique_Nur_Variables <- rapply(data_2013_numeric_variables,function(x)length(unique(x)))

Numeric_Data_Report <- N_Nur %>% 
  cbind(Unique_Nur_Variables) %>% 
  mutate(Missing_Pct = ((Numeric_NA/Numeric_Rows) * 100),
         Unique_Pct = ((Unique_Nur_Variables / Numeric_Rows) * 100),
         Missing_Pct = round(Missing_Pct, digits = 1),
         Unique_Pct = round(Unique_Pct, digits = 1)) %>% 
  dplyr::select(-Numeric_Colnames) %>% 
  rename(N = Numeric_Rows,
         Missing = Numeric_NA,
         "Unique Values" = Unique_Nur_Variables,
         "Missing Percentage" = Missing_Pct,
         "Unique Percentage" = Unique_Pct)
```

```{r}
Character_Data_Report %>% kable()
Numeric_Data_Report %>% kable()
```

```{r team_data}
team_names = unique(data_2021$OffenseTeam)
team_names = team_names[team_names != ""]

team_colors = c("#97233f", "#a71930", "#241773", "#00338d", "#0085ca",
                "#0b162a", "#fb4f14", "#311d00", "#869397", "#FB4F14",
                "#0076B6", "#203731", "#03202F", "#002C5F", "#006778",
                "#e31837", "#003594", "#0073cf", "#000000", "#008e97", 
                "#4f2683", "#c60c30", "#d3bc8d", "#0b2265", "#003f2d", 
                "#004c54", "#FFB612", "#69be28", "#aa0000", "#d50a0a",
                "#4b92db", "#773141") #In order of keys formed below

get_score_diff = function(g,t){
  #Own Score
  ((
    cumsum(g$IsTouchdown & g$OffenseTeam == t & !(g$IsInterception | g$IsFumble))*6 + #Offensive Team TD 
    cumsum(g$IsExp & g$OffenseTeam == t) +  #Extra point
    cumsum(g$IsTwoPointConversionSuccessful & g$OffenseTeam == t)*2 + #2pt conversion
    cumsum(g$IsFieldGoal & g$OffenseTeam == t)*3 + #Field Goal
      cumsum(grepl("SAFETY", g$Description) & g$DefenseTeam == t)*2 + #Forces Safety
      cumsum(g$IsTouchdown & (g$IsInterception | g$IsFumble) & g$DefenseTeam == t) #Defensive TD
  )
  - #Subtract opponent score
  (
    cumsum(g$IsTouchdown & g$DefenseTeam == t & !(g$IsInterception | g$IsFumble))*6 + #Offensive TD
    cumsum(g$IsExp & g$DefenseTeam == t) + #Extra Point
    cumsum(g$IsTwoPointConversionSuccessful & g$DefenseTeam == t)*2 + #2pt conversion
    cumsum(g$IsFieldGoal & g$DefenseTeam == t)*3 + #Field Goal
    cumsum(grepl("SAFETY", g$Description) & g$OffenseTeam == t)*2 + #Forces safety
    cumsum(g$IsTouchdown & (g$IsInterception | g$IsFumble) & g$OffenseTeam == t) #Defensive TD
  )) 
}

teams = hash()

for (t in team_names) {
  teams[[t]] = hash()
  #Get dataset for each team
  team_df = subset(data_2021, (OffenseTeam == t | DefenseTeam == t))
  #For Each team put games and plays in chronological order
  team_df = team_df[with(team_df, order(GameId, Quarter, desc(Minute), desc(Second), Down)), ]
  #Split team into games
  i = 1
  for (g in unique(team_df$GameId)){
    week = sprintf("Week %s", i)
    teams[[t]][[week]] = subset(team_df, GameId == g)
    teams[[t]][[week]]$IsFieldGoal = apply(teams[[t]][[week]], 1, FUN = function(x) (x["PlayType"]=="FIELD GOAL" & !(grepl("NO GOOD", x["Description"]))))
    teams[[t]][[week]]$IsExp = apply(teams[[t]][[week]], 1, FUN = function(x) (x["PlayType"]=="EXTRA POINT" & !(grepl("NO GOOD", x["Description"]))))
    teams[[t]][[week]]$ScoreDiff = get_score_diff(teams[[t]][[week]], t)
    i = i + 1
  }
}


#Example accessing data with hash NOTE: use double brackets
keys(teams)                       #Team abbrv are hash keys
teams[["ARI"]][["Week 1"]]        #Plays for Arizona cardinals first game
teams[["ARI"]][["Week 1"]]$IsRush #Arizona week 1 runs
```

# Dealing with the Data

- Missing Values
  - Rows: Most rows are completely and correctly filled. If we remove rows that have missing/mislabeled data we still have over 17,000 entries to work with so our plan is to just remove any rows that are not correctly filled.
  -Cols: A few columns (namely "X", "X.1", etc.) are completely empty except for a few random values that appear to be in the wrong column. There is also no explanation for what data these columns are supposed to hold so we will remove them.
  
- Outliers, Skews, etc.
  Our plan is to use a decision tree approach which should account for most of these issues. 

#Visualizations

```{r visualize_data}
pass_2021 = subset(data_2021, IsPass == 1)
rush_2021 = subset(data_2021, IsRush == 1)
pt = table(pass_2021$Quarter)
rt = table(rush_2021$Quarter)
#Get breakdown by quarter
Q1_table = c(pt["1"], rt["1"])
Q2_table = c(pt["2"], rt["2"])
Q3_table = c(pt["3"], rt["3"])
Q4_table = c(pt["4"], rt["4"])
#Get total plays
q1_plays = sum(Q1_table)
q2_plays = sum(Q2_table)
q3_plays = sum(Q3_table)
q4_plays = sum(Q4_table)
#Get percent pass/rush by quarter
Q1 = Q1_table / q1_plays
Q2 = Q2_table / q2_plays
Q3 = Q3_table / q3_plays
Q4 = Q4_table / q4_plays

bars = cbind(Q1, Q2, Q3, Q4)
barplot(bars)
legend("bottomright",c("Pass %","Rush %"),fill = c("blue","green"))

#How does score effect ratio
runs_win_1 = 0
runs_win_2 = 0
runs_win_3 = 0
runs_win_4 = 0
runs_tie_1 = 0
runs_tie_2 = 0
runs_tie_3 = 0
runs_tie_4 = 0
runs_lose_1 = 0
runs_lose_2 = 0
runs_lose_3 = 0
runs_lose_4 = 0
pass_win_1 = 0
pass_win_2 = 0
pass_win_3 = 0
pass_win_4 = 0
pass_tie_1 = 0
pass_tie_2 = 0
pass_tie_3 = 0
pass_tie_4 = 0
pass_lose_1 = 0
pass_lose_2 = 0
pass_lose_3 = 0
pass_lose_4 = 0
for (t in keys(teams)){
  for (game in keys(teams[[t]])){
    #Get runs by situation
    runs_win_1 = runs_win_1 + sum(subset(teams[[t]][[game]], ScoreDiff > 0 & Quarter == 1)$IsRush)
    runs_win_2 = runs_win_2 + sum(subset(teams[[t]][[game]], ScoreDiff > 0 & Quarter == 2)$IsRush)
    runs_win_3 = runs_win_3 + sum(subset(teams[[t]][[game]], ScoreDiff > 0 & Quarter == 3)$IsRush)
    runs_win_4 = runs_win_4 + sum(subset(teams[[t]][[game]], ScoreDiff > 0 & Quarter == 4)$IsRush)
    
    runs_tie_1 = runs_tie_1 + sum(subset(teams[[t]][[game]], ScoreDiff == 0 & Quarter == 1)$IsRush)
    runs_tie_2 = runs_tie_2 + sum(subset(teams[[t]][[game]], ScoreDiff == 0 & Quarter == 2)$IsRush)
    runs_tie_3 = runs_tie_3 + sum(subset(teams[[t]][[game]], ScoreDiff == 0 & Quarter == 3)$IsRush)
    runs_tie_4 = runs_tie_4 + sum(subset(teams[[t]][[game]], ScoreDiff == 0 & Quarter == 4)$IsRush)
    
    runs_lose_1 = runs_lose_1 + sum(subset(teams[[t]][[game]], ScoreDiff < 0 & Quarter == 1)$IsRush)
    runs_lose_2 = runs_lose_2 + sum(subset(teams[[t]][[game]], ScoreDiff < 0 & Quarter == 2)$IsRush)
    runs_lose_3 = runs_lose_3 + sum(subset(teams[[t]][[game]], ScoreDiff < 0 & Quarter == 3)$IsRush)
    runs_lose_4 = runs_lose_4 + sum(subset(teams[[t]][[game]], ScoreDiff < 0 & Quarter == 4)$IsRush)
    #Get pass by situation
    pass_win_1 = pass_win_1 + sum(subset(teams[[t]][[game]], ScoreDiff > 0 & Quarter == 1)$IsPass)
    pass_win_2 = pass_win_2 + sum(subset(teams[[t]][[game]], ScoreDiff > 0 & Quarter == 2)$IsPass)
    pass_win_3 = pass_win_3 + sum(subset(teams[[t]][[game]], ScoreDiff > 0 & Quarter == 3)$IsPass)
    pass_win_4 = pass_win_4 + sum(subset(teams[[t]][[game]], ScoreDiff > 0 & Quarter == 4)$IsPass)
    
    pass_tie_1 = pass_tie_1 + sum(subset(teams[[t]][[game]], ScoreDiff == 0 & Quarter == 1)$IsPass)
    pass_tie_2 = pass_tie_2 + sum(subset(teams[[t]][[game]], ScoreDiff == 0 & Quarter == 2)$IsPass)
    pass_tie_3 = pass_tie_3 + sum(subset(teams[[t]][[game]], ScoreDiff == 0 & Quarter == 3)$IsPass)
    pass_tie_4 = pass_tie_4 + sum(subset(teams[[t]][[game]], ScoreDiff == 0 & Quarter == 4)$IsPass)
    
    pass_lose_1 = pass_lose_1 + sum(subset(teams[[t]][[game]], ScoreDiff < 0 & Quarter == 1)$IsPass)
    pass_lose_2 = pass_lose_2 + sum(subset(teams[[t]][[game]], ScoreDiff < 0 & Quarter == 2)$IsPass)
    pass_lose_3 = pass_lose_3 + sum(subset(teams[[t]][[game]], ScoreDiff < 0 & Quarter == 3)$IsPass)
    pass_lose_4 = pass_lose_4 + sum(subset(teams[[t]][[game]], ScoreDiff < 0 & Quarter == 4)$IsPass)
  }
}
q1_ratio = c(pass_win_1/runs_win_1, pass_tie_1/runs_tie_1, pass_lose_1/runs_lose_1)
q2_ratio = c(pass_win_2/runs_win_2, pass_tie_2/runs_tie_2, pass_lose_2/runs_lose_2)
q3_ratio = c(pass_win_3/runs_win_3, pass_tie_3/runs_tie_3, pass_lose_3/runs_lose_3)
q4_ratio = c(pass_win_4/runs_win_4, pass_tie_4/runs_tie_4, pass_lose_4/runs_lose_4)

wtl = cbind(q1_ratio, q2_ratio, q3_ratio, q4_ratio)
barplot(wtl, beside = TRUE, col =c("green","grey","red"))
legend("bottomright",c("Winning","Tied","Losing"),fill = c("green","grey","red"))

#Pass/Run Ratio by team
ratios = c()
for (t in keys(teams)){
  runs = 0
  passes = 0
  for (game in keys(teams[[t]])){
    runs = runs + sum(teams[[t]][[game]]$IsRush)
    passes = passes + sum(teams[[t]][[game]]$IsPass)
  }
  ratios = c(ratios,passes/runs)
}


barplot(ratios, main = "2021 Pass to Run Ratio by Team", 
        names.arg=keys(teams), las=2, cex.names=.5,
        col = team_colors)
```

